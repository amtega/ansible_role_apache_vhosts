{{ ansible_managed | comment }}

<VirtualHost {{ apache_vhosts_vhost.addr | default(apache_vhosts_defaults.addr) }}:{{ apache_vhosts_vhost.port | default(apache_vhosts_defaults.port) }}>
  ServerName {{ apache_vhosts_vhost.server_name | default(apache_vhosts_defaults.server_name) }}

{% for include in apache_vhosts_vhost.includes | default(apache_vhosts_defaults.includes) | default([]) %}
  Include {{ include }}
{% endfor %}

{% if apache_vhosts_vhost.raw_content | default(apache_vhosts_defaults.raw_content) is defined %}
  {{ apache_vhosts_vhost.raw_content | default(apache_vhosts_defaults.raw_content) | indent(width=2) }}
{% endif %}

{% if apache_vhosts_vhost.timeout | default(apache_vhosts_defaults.timeout) is defined %}
  TimeOut {{ apache_vhosts_vhost.timeout | default(apache_vhosts_defaults.timeout) }}
{% endif %}

{% for rule in apache_vhosts_vhost.redirect_match | default(apache_vhosts_defaults.redirect_match) | default([]) %}
  RedirectMatch {{ rule }}
{% endfor %}

{% if apache_vhosts_vhost.rewrite_engine | default(apache_vhosts_defaults.rewrite_engine) | default(false) %}
  RewriteEngine On
{% for rule in apache_vhosts_vhost.rewrite_rules | default(apache_vhosts_defaults.rewrite_rules) | default([]) %}
  RewriteRule {{ rule }}
{% endfor %}
{% endif %}

{% if apache_vhosts_vhost.locations | default(apache_vhosts_defaults.locations) is defined %}
{% for location in apache_vhosts_vhost.locations | default(apache_vhosts_defaults.locations) %}
  <Location {{ location.path }}>
    ProxyPass {{ location.proxy_pass }}
    ProxyPassReverse {{ location.proxy_pass_reverse }}
  </Location>
{% endfor %}
{% endif %}

{% for proxy_pass in apache_vhosts_vhost.proxy_pass | default(apache_vhosts_defaults.proxy_pass) | default([]) %}
  ProxyPass {{ proxy_pass }}
{% endfor %}

{% for proxy_pass_reverse in apache_vhosts_vhost.proxy_pass_reverse | default(apache_vhosts_defaults.proxy_pass_reverse) | default([]) %}
  ProxyPassReverse {{ proxy_pass_reverse }}
{% endfor %}

{% for header in apache_vhosts_vhost.headers | default(apache_vhosts_defaults.headers) | default([]) %}
  Header {{ header }}
{% endfor %}

{% if apache_vhosts_vhost.balancer | default(apache_vhosts_defaults.balancer) is defined %}
  <Proxy balancer://{{ apache_vhosts_vhost.balancer.name | default(apache_vhosts_defaults.balancer.name) }}>
{% for member in apache_vhosts_vhost.balancer.members | default(apache_vhosts_defaults.balancer.members) %}
    BalancerMember {{ member }}
{% endfor %}
    ProxySet lbmethod={{ apache_vhosts_vhost.balancer.lbmethod | default(apache_vhosts_defaults.balancer.lbmethod) }} stickysession={{ apache_vhosts_vhost.balancer.sticky_session | default(apache_vhosts_defaults.balancer.sticky_session) }}
 </Proxy>
{% endif %}

{% if apache_vhosts_vhost.error_log | default(apache_vhosts_defaults.error_log) is defined %}
  ErrorLog {{ apache_vhosts_vhost.error_log | default(apache_vhosts_defaults.error_log) }}
{% endif %}
</VirtualHost>
